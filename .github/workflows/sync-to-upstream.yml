name: Sync to Upstream Repository

on:
  push:
    branches:
      - main
    # åªå¤„ç†ä»“åº“ owner çš„æäº¤ï¼ˆè§¦å‘ CD çš„æäº¤ï¼‰
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  UPSTREAM_REPO: OpenRareDisease/info_platform
  UPSTREAM_BRANCH: main

jobs:
  check-deployment:
    name: Wait for Vercel Deployment
    runs-on: ubuntu-latest
    if: github.repository_owner == 'demongodYY' # åªåœ¨ä¸‹æ¸¸ä»“åº“è¿è¡Œ
    outputs:
      deployment-status: ${{ steps.check.outputs.status }}
    steps:
      - name: Check Vercel deployment status
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commitSha = '${{ github.sha }}';
            const maxWaitTime = 10 * 60 * 1000; // 10 åˆ†é’Ÿ
            const checkInterval = 30 * 1000; // 30 ç§’æ£€æŸ¥ä¸€æ¬¡
            const startTime = Date.now();
            
            console.log(`ğŸ” Checking deployment status for commit: ${commitSha}`);
            
            while (Date.now() - startTime < maxWaitTime) {
              try {
                // æ£€æŸ¥ GitHub Deployments API
                const { data: deployments } = await github.rest.repos.listDeployments({
                  owner: process.env.GITHUB_REPOSITORY_OWNER,
                  repo: process.env.GITHUB_REPOSITORY.split('/')[1],
                  sha: commitSha,
                  per_page: 1,
                });
                
                if (deployments.length > 0) {
                  const deployment = deployments[0];
                  console.log(`ğŸ“¦ Found deployment: ${deployment.id}`);
                  
                  // æ£€æŸ¥ deployment status
                  const { data: statuses } = await github.rest.repos.listDeploymentStatuses({
                    owner: process.env.GITHUB_REPOSITORY_OWNER,
                    repo: process.env.GITHUB_REPOSITORY.split('/')[1],
                    deployment_id: deployment.id,
                    per_page: 1,
                  });
                  
                  if (statuses.length > 0) {
                    const status = statuses[0];
                    console.log(`ğŸ“Š Deployment status: ${status.state}`);
                    
                    if (status.state === 'success') {
                      console.log('âœ… Deployment succeeded!');
                      core.setOutput('status', 'success');
                      return;
                    } else if (status.state === 'failure' || status.state === 'error') {
                      console.log(`âŒ Deployment failed: ${status.state}`);
                      core.setOutput('status', 'failure');
                      return;
                    }
                  }
                }
                
                // ä¹Ÿæ£€æŸ¥ commit statusï¼ˆVercel å¯èƒ½ä¼šè®¾ç½®ï¼‰
                const { data: statuses } = await github.rest.repos.getCombinedStatusForRef({
                  owner: process.env.GITHUB_REPOSITORY_OWNER,
                  repo: process.env.GITHUB_REPOSITORY.split('/')[1],
                  ref: commitSha,
                });
                
                const vercelStatus = statuses.statuses.find(s => 
                  s.context.includes('vercel') || s.context.includes('Vercel')
                );
                
                if (vercelStatus) {
                  console.log(`ğŸ“Š Vercel status: ${vercelStatus.state}`);
                  if (vercelStatus.state === 'success') {
                    console.log('âœ… Vercel deployment succeeded!');
                    core.setOutput('status', 'success');
                    return;
                  } else if (vercelStatus.state === 'failure' || vercelStatus.state === 'error') {
                    console.log(`âŒ Vercel deployment failed: ${vercelStatus.state}`);
                    core.setOutput('status', 'failure');
                    return;
                  }
                }
                
                console.log('â³ Deployment in progress, waiting...');
                await new Promise(resolve => setTimeout(resolve, checkInterval));
              } catch (error) {
                console.log(`âš ï¸ Error checking deployment: ${error.message}`);
                // ç»§ç»­ç­‰å¾…
                await new Promise(resolve => setTimeout(resolve, checkInterval));
              }
            }
            
            // è¶…æ—¶åï¼Œå¦‚æœè¿˜æ²¡æ‰¾åˆ°éƒ¨ç½²çŠ¶æ€ï¼Œå‡è®¾æˆåŠŸï¼ˆå¯èƒ½æ˜¯ Vercel è¿˜æ²¡åˆ›å»º statusï¼‰
            console.log('â° Timeout reached, assuming deployment will succeed');
            core.setOutput('status', 'timeout');

  sync-to-upstream:
    name: Create PR to Upstream
    needs: check-deployment
    runs-on: ubuntu-latest
    if: github.repository_owner == 'demongodYY' && (needs.check-deployment.outputs.deployment-status == 'success' || needs.check-deployment.outputs.deployment-status == 'timeout')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git || true
          git remote set-url upstream https://github.com/${{ env.UPSTREAM_REPO }}.git

      - name: Fetch upstream
        run: |
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}

      - name: Check for changes
        id: check-changes
        run: |
          # æ£€æŸ¥å½“å‰åˆ†æ”¯å’Œä¸Šæ¸¸åˆ†æ”¯æ˜¯å¦æœ‰å·®å¼‚
          if git diff --quiet HEAD upstream/${{ env.UPSTREAM_BRANCH }}; then
            echo "no-changes=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes to sync"
          else
            echo "no-changes=false" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected, will create PR"
            # æ˜¾ç¤ºå˜æ›´ç»Ÿè®¡
            echo "ğŸ“Š Change summary:"
            git diff --stat HEAD upstream/${{ env.UPSTREAM_BRANCH }}
          fi

      - name: Check for existing PRs
        if: steps.check-changes.outputs.no-changes == 'false'
        id: check-prs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: 'OpenRareDisease',
              repo: 'info_platform',
              state: 'open',
            });
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœªåˆå¹¶çš„åŒæ­¥ PRï¼ˆä»å½“å‰ fork åˆ›å»ºçš„ï¼‰
            const [forkOwner] = process.env.GITHUB_REPOSITORY.split('/');
            const syncPRs = prs.filter(pr => 
              pr.head.repo.full_name === process.env.GITHUB_REPOSITORY &&
              pr.head.ref === 'main'
            );
            
            if (syncPRs.length > 0) {
              console.log(`âš ï¸ Found ${syncPRs.length} existing sync PR(s):`);
              syncPRs.forEach(pr => {
                console.log(`  - #${pr.number}: ${pr.title} (${pr.head.ref})`);
              });
              core.setOutput('has-open-pr', 'true');
              core.setOutput('pr-number', syncPRs[0].number.toString());
            } else {
              console.log('âœ… No existing sync PR found');
              core.setOutput('has-open-pr', 'false');
            }

      - name: Check PAT configuration
        if: steps.check-changes.outputs.no-changes == 'false' && steps.check-prs.outputs.has-open-pr == 'false'
        id: check-pat
        run: |
          if [ -z "${{ secrets.PAT }}" ]; then
            echo "âŒ PAT secret is not configured!"
            echo ""
            echo "Please configure PAT secret:"
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: PAT"
            echo "4. Value: Your Personal Access Token with 'public_repo' scope"
            echo "5. Click 'Add secret'"
            echo ""
            echo "To create PAT:"
            echo "1. Go to: https://github.com/settings/tokens"
            echo "2. Click 'Generate new token (classic)'"
            echo "3. Select 'public_repo' scope"
            echo "4. Generate and copy the token"
            exit 1
          else
            echo "âœ… PAT secret is configured"
          fi

      - name: Create Pull Request using GitHub API
        if: steps.check-changes.outputs.no-changes == 'false' && steps.check-prs.outputs.has-open-pr == 'false' && steps.check-pat.outcome == 'success'
        id: create-pr
        uses: actions/github-script@v7
        with:
          # å¿…é¡»ä½¿ç”¨ PATï¼ŒGITHUB_TOKEN æ— æ³•è·¨ä»“åº“åˆ›å»º PR
          github-token: ${{ secrets.PAT }}
          script: |
            // å†æ¬¡æ£€æŸ¥ PATï¼ˆåŒé‡ä¿é™©ï¼‰
            if (!process.env.GITHUB_TOKEN || process.env.GITHUB_TOKEN === '') {
              core.setFailed('âŒ PAT secret is required to create PR to upstream repository. Please configure PAT secret in repository settings.');
              return;
            }
            
            const commitMessage = ${{ toJSON(github.event.head_commit.message) }};
            const commitAuthor = ${{ toJSON(github.event.head_commit.author.name) }};
            const commitTime = ${{ toJSON(github.event.head_commit.timestamp) }};
            const commitSha = ${{ toJSON(github.sha) }};
            const repo = ${{ toJSON(github.repository) }};
            const beforeSha = ${{ toJSON(github.event.before) }};
            const deploymentStatus = ${{ toJSON(needs.check-deployment.outputs.deployment-status) }};
            const forkOwner = ${{ toJSON(github.repository_owner) }};
            
            // è·å–éƒ¨ç½²çŠ¶æ€æ–‡æœ¬
            const deploymentStatusEmoji = deploymentStatus === 'success' ? 'âœ…' : 'â°';
            const deploymentStatusText = deploymentStatus === 'success' 
              ? 'Vercel éƒ¨ç½²å·²æˆåŠŸå®Œæˆ' 
              : 'Vercel éƒ¨ç½²çŠ¶æ€æ£€æŸ¥è¶…æ—¶ï¼ˆå¯èƒ½ä»åœ¨è¿›è¡Œä¸­ï¼‰';
            
            // åˆ›å»º PR body
            const prBody = [
              '## ğŸ”„ è‡ªåŠ¨åŒæ­¥æ›´æ–°',
              '',
              'æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºï¼Œç”¨äºåŒæ­¥ä¸‹æ¸¸ä»“åº“çš„æ›´æ–°ã€‚',
              '',
              '**æ¥æºä»“åº“**: [' + repo + '](https://github.com/' + repo + ')',
              '**æäº¤**: [`' + commitSha.substring(0, 7) + '`](https://github.com/' + repo + '/commit/' + commitSha + ')',
              '**æäº¤ä¿¡æ¯**: ' + commitMessage,
              '**ä½œè€…**: ' + commitAuthor,
              '**æäº¤æ—¶é—´**: ' + commitTime,
              '',
              '**éƒ¨ç½²çŠ¶æ€**: ' + deploymentStatusEmoji + ' ' + deploymentStatusText,
              '',
              '---',
              '',
              '### ğŸ“‹ å˜æ›´å†…å®¹',
              '',
              'æœ¬æ¬¡åŒæ­¥åŒ…å«ä»¥ä¸‹å˜æ›´ï¼š',
              '- æäº¤ SHA: `' + commitSha + '`',
              '- å˜æ›´æ–‡ä»¶: æŸ¥çœ‹ [æ–‡ä»¶å˜æ›´](https://github.com/' + repo + '/compare/' + beforeSha + '...' + commitSha + ')',
              '',
              '### âœ… æ£€æŸ¥æ¸…å•',
              '',
              '- [x] Vercel éƒ¨ç½²çŠ¶æ€å·²æ£€æŸ¥',
              '- [ ] ä»£ç å·²é€šè¿‡æµ‹è¯•',
              '- [ ] å·²æ£€æŸ¥å˜æ›´å†…å®¹',
              '- [ ] ç¡®è®¤æ— å†²çª',
              '',
              '> âš ï¸ **æ³¨æ„**: æ­¤ PR ç”±è‡ªåŠ¨åŒ–æµç¨‹åˆ›å»ºï¼Œè¯·ä»”ç»†å®¡æŸ¥åå†åˆå¹¶ã€‚',
              '',
              '---',
              '',
              '*æ­¤ PR ç”± [GitHub Actions](' + process.env.GITHUB_SERVER_URL + '/' + repo + '/actions/runs/' + process.env.GITHUB_RUN_ID + ') è‡ªåŠ¨åˆ›å»º*'
            ].join('\n');
            
            // PR æ ‡é¢˜ï¼ˆåªå–ç¬¬ä¸€è¡Œï¼‰
            const prTitle = 'ğŸ”„ Sync from downstream: ' + commitMessage.split('\n')[0];
            
            try {
              console.log('Creating PR from fork: ' + forkOwner + ':main to OpenRareDisease/info_platform:main');
              
              // å…ˆæ£€æŸ¥ PAT æ˜¯å¦æœ‰æƒé™è®¿é—®ä¸Šæ¸¸ä»“åº“
              try {
                const { data: upstreamRepo } = await github.rest.repos.get({
                  owner: 'OpenRareDisease',
                  repo: 'info_platform',
                });
                console.log('âœ… Can access upstream repository: ' + upstreamRepo.full_name);
                console.log('   Repository is ' + (upstreamRepo.private ? 'private' : 'public'));
              } catch (accessError) {
                if (accessError.status === 404) {
                  core.setFailed('âŒ Upstream repository not found. Please check the repository name: OpenRareDisease/info_platform');
                  return;
                } else if (accessError.status === 403) {
                  core.setFailed('âŒ Permission denied accessing upstream repository. Please ensure:\n' +
                    '  1. PAT has "public_repo" scope (for public repos) or "repo" scope (for private repos)\n' +
                    '  2. PAT owner is a member of OpenRareDisease organization (if it\'s an org repo)');
                  return;
                }
                throw accessError;
              }
              
              // ä½¿ç”¨ GitHub API åˆ›å»º PR
              const { data: pr } = await github.rest.pulls.create({
                owner: 'OpenRareDisease',
                repo: 'info_platform',
                title: prTitle,
                body: prBody,
                head: forkOwner + ':main', // fork ä»“åº“çš„ main åˆ†æ”¯
                base: 'main',
              });
              
              console.log('âœ… Successfully created PR #' + pr.number);
              console.log('ğŸ”— PR URL: ' + pr.html_url);
              
              // æ·»åŠ æ ‡ç­¾ï¼ˆå¯é€‰ï¼Œå¤±è´¥ä¸å½±å“ PR åˆ›å»ºï¼‰
              try {
                await github.rest.issues.addLabels({
                  owner: 'OpenRareDisease',
                  repo: 'info_platform',
                  issue_number: pr.number,
                  labels: ['automated', 'sync'],
                });
                console.log('âœ… Added labels: automated, sync');
              } catch (labelError) {
                console.log('âš ï¸ Failed to add labels (may not have permission, but PR was created): ' + labelError.message);
                console.log('   This is not critical - PR was successfully created.');
              }
              
              core.setOutput('pr-number', pr.number.toString());
              core.setOutput('pr-url', pr.html_url);
            } catch (error) {
              console.error('âŒ Failed to create PR:', error.message);
              console.error('   Error status:', error.status);
              console.error('   Error details:', JSON.stringify(error.response?.data || {}, null, 2));
              
              if (error.status === 403) {
                const errorMsg = error.response?.data?.message || error.message;
                let detailedMsg = 'âŒ Permission denied. Possible reasons:\n';
                detailedMsg += '  1. PAT does not have required scope:\n';
                detailedMsg += '     - For public repos: "public_repo" scope is required\n';
                detailedMsg += '     - For private repos: "repo" scope is required\n';
                detailedMsg += '  2. Upstream repository may not allow PRs from forks\n';
                detailedMsg += '  3. PAT owner may not be a member of OpenRareDisease organization\n';
                detailedMsg += '  4. Fork may not be properly synced with upstream\n';
                detailedMsg += '\nOriginal error: ' + errorMsg;
                core.setFailed(detailedMsg);
              } else if (error.status === 422) {
                const errorMsg = error.response?.data?.message || error.message;
                const errors = error.response?.data?.errors || [];
                let detailedMsg = 'âŒ PR creation failed (422 Unprocessable Entity):\n';
                detailedMsg += '  ' + errorMsg + '\n';
                if (errors.length > 0) {
                  detailedMsg += '\n  Details:\n';
                  errors.forEach(err => {
                    detailedMsg += '    - ' + JSON.stringify(err) + '\n';
                  });
                }
                detailedMsg += '\nPossible reasons:\n';
                detailedMsg += '  1. PR already exists from this fork\n';
                detailedMsg += '  2. No changes between fork and upstream\n';
                detailedMsg += '  3. Branch name mismatch\n';
                core.setFailed(detailedMsg);
              } else if (error.status === 404) {
                core.setFailed('âŒ Repository not found. Please check:\n' +
                  '  1. Repository name is correct: OpenRareDisease/info_platform\n' +
                  '  2. Repository exists and is accessible\n' +
                  '  3. Fork exists: ' + forkOwner + '/info_platform_fork');
              } else {
                core.setFailed('âŒ Unexpected error: ' + error.message + '\nStatus: ' + error.status);
                throw error;
              }
            }

      - name: Comment on existing PR
        if: steps.check-changes.outputs.no-changes == 'false' && steps.check-prs.outputs.has-open-pr == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.check-prs.outputs.pr-number }}');
            const commitMessage = ${{ toJSON(github.event.head_commit.message) }};
            const commitSha = ${{ toJSON(github.sha) }};
            const repo = ${{ toJSON(github.repository) }};
            const beforeSha = ${{ toJSON(github.event.before) }};
            const commitAuthor = ${{ toJSON(github.event.head_commit.author.name) }};
            
            const comment = [
              'ğŸ”„ **è‡ªåŠ¨æ›´æ–°é€šçŸ¥**',
              '',
              'æ£€æµ‹åˆ°æ–°çš„æäº¤ï¼Œä½†å·²å­˜åœ¨æœªåˆå¹¶çš„åŒæ­¥ PR #' + prNumber + 'ã€‚',
              '',
              'è¯·å…ˆåˆå¹¶æˆ–å…³é—­ç°æœ‰ PRï¼Œç„¶åå†åˆ›å»ºæ–°çš„åŒæ­¥ PRã€‚',
              '',
              '**æ–°æäº¤ä¿¡æ¯**:',
              '- SHA: `' + commitSha.substring(0, 7) + '`',
              '- æ¶ˆæ¯: ' + commitMessage,
              '- ä½œè€…: ' + commitAuthor,
              '',
              '[æŸ¥çœ‹å˜æ›´](https://github.com/' + repo + '/compare/' + beforeSha + '...' + commitSha + ')'
            ].join('\n');
            
            await github.rest.issues.createComment({
              owner: 'OpenRareDisease',
              repo: 'info_platform',
              issue_number: prNumber,
              body: comment
            });
            
            console.log(`âœ… Commented on existing PR #${prNumber}`);

      - name: Summary
        if: steps.check-changes.outputs.no-changes == 'false'
        run: |
          echo "ğŸ“Š Workflow Summary:"
          echo "==================="
          echo "Repository: ${{ github.repository }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Deployment Status: ${{ needs.check-deployment.outputs.deployment-status }}"
          echo ""
          
          if [ "${{ steps.check-prs.outputs.has-open-pr }}" == "true" ]; then
            echo "âš ï¸ Existing PR found, commented on it instead of creating new one"
            echo "PR Number: ${{ steps.check-prs.outputs.pr-number }}"
            echo "PR URL: https://github.com/OpenRareDisease/info_platform/pull/${{ steps.check-prs.outputs.pr-number }}"
          else
            if [ -n "${{ steps.create-pr.outputs.pr-number }}" ]; then
              echo "âœ… Successfully created PR to upstream repository"
              echo "PR Number: ${{ steps.create-pr.outputs.pr-number }}"
              echo "PR URL: ${{ steps.create-pr.outputs.pr-url }}"
            else
              echo "âŒ PR creation failed. Check the logs above for details."
              echo "Common issues:"
              echo "  1. PAT secret not configured"
              echo "  2. PAT doesn't have 'public_repo' permission"
              echo "  3. Upstream repository doesn't allow PRs from forks"
            fi
          fi

      - name: No changes message
        if: steps.check-changes.outputs.no-changes == 'true'
        run: |
          echo "â„¹ï¸ No changes detected, skipping PR creation"
