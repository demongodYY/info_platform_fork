name: Sync to Upstream Repository

on:
  push:
    branches:
      - main
    # åªå¤„ç†ä»“åº“ owner çš„æäº¤ï¼ˆè§¦å‘ CD çš„æäº¤ï¼‰
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  UPSTREAM_REPO: OpenRareDisease/info_platform
  UPSTREAM_BRANCH: main

jobs:
  wait-for-deployment:
    name: Wait for Vercel Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Wait for deployment
        run: |
          echo "â³ Waiting for Vercel deployment to complete..."
          echo "This gives Vercel time to build and deploy the changes."
          # ç­‰å¾… 3 åˆ†é’Ÿè®© Vercel æœ‰æ—¶é—´å®Œæˆéƒ¨ç½²
          # å¦‚æœ Vercel éƒ¨ç½²æ—¶é—´è¾ƒé•¿ï¼Œå¯ä»¥å¢åŠ è¿™ä¸ªæ—¶é—´
          sleep 180
          echo "âœ… Deployment wait completed"

  sync-to-upstream:
    name: Create PR to Upstream
    needs: wait-for-deployment
    runs-on: ubuntu-latest
    if: github.repository_owner == 'demongodYY' # åªåœ¨ä¸‹æ¸¸ä»“åº“è¿è¡Œ
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git || true
          git remote set-url upstream https://github.com/${{ env.UPSTREAM_REPO }}.git

      - name: Fetch upstream
        run: |
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}

      - name: Check for changes
        id: check-changes
        run: |
          # æ£€æŸ¥å½“å‰åˆ†æ”¯å’Œä¸Šæ¸¸åˆ†æ”¯æ˜¯å¦æœ‰å·®å¼‚
          if git diff --quiet HEAD upstream/${{ env.UPSTREAM_BRANCH }}; then
            echo "no-changes=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes to sync"
          else
            echo "no-changes=false" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected, will create PR"
            # æ˜¾ç¤ºå˜æ›´ç»Ÿè®¡
            echo "ğŸ“Š Change summary:"
            git diff --stat HEAD upstream/${{ env.UPSTREAM_BRANCH }}
          fi

      - name: Check for existing PRs
        if: steps.check-changes.outputs.no-changes == 'false'
        id: check-prs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: 'OpenRareDisease',
              repo: 'info_platform',
              state: 'open',
            });
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœªåˆå¹¶çš„åŒæ­¥ PRï¼ˆç”± bot åˆ›å»ºçš„æˆ–æ ‡é¢˜åŒ…å« syncï¼‰
            const syncPRs = prs.filter(pr => 
              pr.head.ref.startsWith('sync-') || 
              pr.title.includes('Sync from downstream') ||
              pr.user.login === 'github-actions[bot]'
            );
            
            if (syncPRs.length > 0) {
              console.log(`âš ï¸ Found ${syncPRs.length} existing sync PR(s):`);
              syncPRs.forEach(pr => {
                console.log(`  - #${pr.number}: ${pr.title} (${pr.head.ref})`);
              });
              core.setOutput('has-open-pr', 'true');
              core.setOutput('pr-number', syncPRs[0].number.toString());
            } else {
              console.log('âœ… No existing sync PR found');
              core.setOutput('has-open-pr', 'false');
            }

      - name: Create Pull Request using GitHub API
        if: steps.check-changes.outputs.no-changes == 'false' && steps.check-prs.outputs.has-open-pr == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commitMessage = '${{ github.event.head_commit.message }}'.replace(/'/g, "\\'");
            const commitAuthor = '${{ github.event.head_commit.author.name }}';
            const commitTime = '${{ github.event.head_commit.timestamp }}';
            const commitSha = '${{ github.sha }}';
            const repo = '${{ github.repository }}';
            const beforeSha = '${{ github.event.before }}';
            
            // åˆ›å»º PR çš„ body
            const prBody = `## ğŸ”„ è‡ªåŠ¨åŒæ­¥æ›´æ–°
            
            æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºï¼Œç”¨äºåŒæ­¥ä¸‹æ¸¸ä»“åº“çš„æ›´æ–°ã€‚
            
            **æ¥æºä»“åº“**: [${repo}](https://github.com/${repo})
            **æäº¤**: [\`${commitSha.substring(0, 7)}\`](https://github.com/${repo}/commit/${commitSha})
            **æäº¤ä¿¡æ¯**: ${commitMessage}
            **ä½œè€…**: ${commitAuthor}
            **æäº¤æ—¶é—´**: ${commitTime}
            
            **éƒ¨ç½²çŠ¶æ€**: âœ… Vercel éƒ¨ç½²å·²å®Œæˆï¼ˆç­‰å¾… 3 åˆ†é’Ÿååˆ›å»ºæ­¤ PRï¼‰
            
            ---
            
            ### ğŸ“‹ å˜æ›´å†…å®¹
            
            æœ¬æ¬¡åŒæ­¥åŒ…å«ä»¥ä¸‹å˜æ›´ï¼š
            - æäº¤ SHA: \`${commitSha}\`
            - å˜æ›´æ–‡ä»¶: æŸ¥çœ‹ [æ–‡ä»¶å˜æ›´](https://github.com/${repo}/compare/${beforeSha}...${commitSha})
            
            ### âœ… æ£€æŸ¥æ¸…å•
            
            - [ ] ä»£ç å·²é€šè¿‡æµ‹è¯•
            - [ ] Vercel éƒ¨ç½²å·²æˆåŠŸå®Œæˆ
            - [ ] å·²æ£€æŸ¥å˜æ›´å†…å®¹
            - [ ] ç¡®è®¤æ— å†²çª
            
            > âš ï¸ **æ³¨æ„**: æ­¤ PR ç”±è‡ªåŠ¨åŒ–æµç¨‹åˆ›å»ºï¼Œè¯·ä»”ç»†å®¡æŸ¥åå†åˆå¹¶ã€‚
            
            ---
            
            *æ­¤ PR ç”± [GitHub Actions](${process.env.GITHUB_SERVER_URL}/${repo}/actions/runs/${process.env.GITHUB_RUN_ID}) è‡ªåŠ¨åˆ›å»º*`;
            
            try {
              // ä½¿ç”¨ GitHub API åˆ›å»º PR
              // head æ ¼å¼: owner:branchï¼ŒæŒ‡å‘ fork ä»“åº“çš„ main åˆ†æ”¯
              // ä» GITHUB_REPOSITORY ç¯å¢ƒå˜é‡è·å– fork æ‰€æœ‰è€…
              const [forkOwner] = process.env.GITHUB_REPOSITORY.split('/');
              console.log(`Creating PR from fork: ${forkOwner}:main`);
              
              const { data: pr } = await github.rest.pulls.create({
                owner: 'OpenRareDisease',
                repo: 'info_platform',
                title: `ğŸ”„ Sync from downstream: ${commitMessage}`,
                body: prBody,
                head: `${forkOwner}:main`, // fork ä»“åº“çš„ main åˆ†æ”¯
                base: 'main',
              });
              
              console.log(`âœ… Successfully created PR #${pr.number}`);
              console.log(`ğŸ”— PR URL: ${pr.html_url}`);
              
              // æ·»åŠ æ ‡ç­¾
              await github.rest.issues.addLabels({
                owner: 'OpenRareDisease',
                repo: 'info_platform',
                issue_number: pr.number,
                labels: ['automated', 'sync'],
              });
              
              core.setOutput('pr-number', pr.number.toString());
              core.setOutput('pr-url', pr.html_url);
            } catch (error) {
              console.error('âŒ Failed to create PR:', error.message);
              if (error.status === 422) {
                console.log('âš ï¸ PR might already exist or there are no changes');
              }
              throw error;
            }

      - name: Comment on existing PR
        if: steps.check-changes.outputs.no-changes == 'false' && steps.check-prs.outputs.has-open-pr == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.check-prs.outputs.pr-number }}');
            const commitMessage = '${{ github.event.head_commit.message }}'.replace(/'/g, "\\'");
            const commitSha = '${{ github.sha }}';
            const repo = '${{ github.repository }}';
            const beforeSha = '${{ github.event.before }}';
            
            const comment = `ğŸ”„ **è‡ªåŠ¨æ›´æ–°é€šçŸ¥**
            
            æ£€æµ‹åˆ°æ–°çš„æäº¤ï¼Œä½†å·²å­˜åœ¨æœªåˆå¹¶çš„åŒæ­¥ PR #${prNumber}ã€‚
            
            è¯·å…ˆåˆå¹¶æˆ–å…³é—­ç°æœ‰ PRï¼Œç„¶åå†åˆ›å»ºæ–°çš„åŒæ­¥ PRã€‚
            
            **æ–°æäº¤ä¿¡æ¯**:
            - SHA: \`${commitSha.substring(0, 7)}\`
            - æ¶ˆæ¯: ${commitMessage}
            - ä½œè€…: ${{ github.event.head_commit.author.name }}
            
            [æŸ¥çœ‹å˜æ›´](https://github.com/${repo}/compare/${beforeSha}...${commitSha})`;
            
            await github.rest.issues.createComment({
              owner: 'OpenRareDisease',
              repo: 'info_platform',
              issue_number: prNumber,
              body: comment
            });
            
            console.log(`âœ… Commented on existing PR #${prNumber}`);

      - name: Summary
        if: steps.check-changes.outputs.no-changes == 'false'
        run: |
          if [ "${{ steps.check-prs.outputs.has-open-pr }}" == "true" ]; then
            echo "âš ï¸ Existing PR found, commented on it instead of creating new one"
            echo "PR Number: ${{ steps.check-prs.outputs.pr-number }}"
          else
            echo "âœ… Successfully created PR to upstream repository"
            echo "PR Number: ${{ steps.create-pr.outputs.pr-number }}"
            echo "PR URL: ${{ steps.create-pr.outputs.pr-url }}"
          fi

      - name: No changes message
        if: steps.check-changes.outputs.no-changes == 'true'
        run: |
          echo "â„¹ï¸ No changes detected, skipping PR creation"
