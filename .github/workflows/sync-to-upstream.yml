name: Sync to Upstream Repository

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  UPSTREAM_OWNER: OpenRareDisease
  UPSTREAM_REPO: info_platform
  UPSTREAM_BRANCH: main

jobs:
  sync-to-upstream:
    name: Sync downstream â†’ upstream
    runs-on: ubuntu-latest

    # åªå…è®¸ä»“åº“ owner æœ¬äººè§¦å‘ï¼ˆé¿å… bot / fork / dependabot æ‹¿ä¸åˆ° secretsï¼‰
    if: github.repository_owner == 'demongodYY' && github.actor == 'demongodYY'

    steps:
      # ------------------------------------------------------------
      # åŸºç¡€è°ƒè¯•ä¿¡æ¯ï¼ˆä¸æ¶‰åŠ secretsï¼‰
      # ------------------------------------------------------------
      - name: Debug context
        run: |
          echo "ğŸ” Debug context"
          echo "actor: $GITHUB_ACTOR"
          echo "event: $GITHUB_EVENT_NAME"
          echo "ref:   $GITHUB_REF"
          echo "sha:   $GITHUB_SHA"
          echo "repo:  $GITHUB_REPOSITORY"

      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # ------------------------------------------------------------
      # æ·»åŠ å¹¶æ‹‰å– upstream
      # ------------------------------------------------------------
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}.git || true
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}

      # ------------------------------------------------------------
      # æ£€æŸ¥æ˜¯å¦æœ‰å·®å¼‚
      # ------------------------------------------------------------
      - name: Check for changes
        id: diff
        run: |
          if git diff --quiet HEAD upstream/${{ env.UPSTREAM_BRANCH }}; then
            echo "no-changes=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected"
          else
            echo "no-changes=false" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected:"
            git diff --stat HEAD upstream/${{ env.UPSTREAM_BRANCH }}
          fi

      # ------------------------------------------------------------
      # ä½¿ç”¨ PAT è°ƒè¯•ï¼šèƒ½å¦è®¿é—® upstreamï¼ˆä¸æ³„éœ² tokenï¼‰
      # ------------------------------------------------------------
      - name: Debug PAT access to upstream repo
        if: steps.diff.outputs.no-changes == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            console.log('ğŸ” PAT provided to github-script');

            try {
              const { data } = await github.rest.repos.get({
                owner: process.env.UPSTREAM_OWNER,
                repo: process.env.UPSTREAM_REPO,
              });

              console.log(`âœ… Can access upstream repo: ${data.full_name}`);
              console.log(`   Visibility: ${data.private ? 'private' : 'public'}`);
            } catch (err) {
              console.error('âŒ Cannot access upstream repo');
              console.error('Status:', err.status);
              console.error('Message:', err.message);
              throw err;
            }

      # ------------------------------------------------------------
      # æ£€æŸ¥æ˜¯å¦å·²æœ‰æœªåˆå¹¶ PR
      # ------------------------------------------------------------
      - name: Check existing PRs
        if: steps.diff.outputs.no-changes == 'false'
        id: pr-check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const owner = process.env.UPSTREAM_OWNER;
            const repo  = process.env.UPSTREAM_REPO;
            const fork  = process.env.GITHUB_REPOSITORY;

            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
            });

            const existing = prs.find(pr =>
              pr.head.repo.full_name === fork &&
              pr.head.ref === 'main'
            );

            if (existing) {
              console.log(`âš ï¸ Existing PR found: #${existing.number}`);
              core.setOutput('exists', 'true');
              core.setOutput('number', existing.number.toString());
            } else {
              console.log('âœ… No existing PR found');
              core.setOutput('exists', 'false');
            }

      # ------------------------------------------------------------
      # åˆ›å»º PRï¼ˆå…³é”®ï¼šä¸å†è‡ªå·±è¯» env tokenï¼‰
      # ------------------------------------------------------------
      - name: Create PR to upstream
        if: steps.diff.outputs.no-changes == 'false' && steps.pr-check.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const owner = process.env.UPSTREAM_OWNER;
            const repo  = process.env.UPSTREAM_REPO;
            const forkOwner = process.env.GITHUB_REPOSITORY_OWNER;

            const sha = process.env.GITHUB_SHA;
            const repoFull = process.env.GITHUB_REPOSITORY;

            const title = `ğŸ”„ Sync from downstream (${sha.substring(0,7)})`;
            const body = `
            ## ğŸ”„ è‡ªåŠ¨åŒæ­¥æ›´æ–°

            **æ¥æºä»“åº“**: ${repoFull}
            **æäº¤ SHA**: \`${sha}\`

            æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºã€‚
            `;

            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title,
              body,
              head: `${forkOwner}:main`,
              base: 'main',
            });

            console.log(`âœ… PR created: #${pr.number}`);
            console.log(`ğŸ”— ${pr.html_url}`);

      # ------------------------------------------------------------
      # æ— å˜æ›´æç¤º
      # ------------------------------------------------------------
      - name: No changes
        if: steps.diff.outputs.no-changes == 'true'
        run: echo "â„¹ï¸ Nothing to sync"