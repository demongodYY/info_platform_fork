name: Sync to Upstream Repository

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  UPSTREAM_OWNER: OpenRareDisease
  UPSTREAM_REPO: info_platform
  UPSTREAM_BRANCH: main

jobs:
  check-deployment:
    name: Wait for Vercel Deployment
    runs-on: ubuntu-latest

    # åªåœ¨ä¸‹æ¸¸ä»“åº“ + ä½ æœ¬äººè§¦å‘æ—¶è·‘ï¼ˆé¿å… bot / å¤–éƒ¨è§¦å‘å¯¼è‡´ secrets / çŠ¶æ€å¼‚å¸¸ï¼‰
    if: github.repository_owner == 'demongodYY' && github.actor == 'demongodYY'

    outputs:
      deployment-status: ${{ steps.check.outputs.status }}

    steps:
      - name: Debug context
        run: |
          echo "ğŸ” Debug context"
          echo "actor: $GITHUB_ACTOR"
          echo "event: $GITHUB_EVENT_NAME"
          echo "ref:   $GITHUB_REF"
          echo "sha:   $GITHUB_SHA"
          echo "repo:  $GITHUB_REPOSITORY"

      - name: Check Vercel deployment status
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commitSha = process.env.GITHUB_SHA;

            const maxWaitTime = 10 * 60 * 1000; // 10 min
            const checkInterval = 30 * 1000;    // 30 sec
            const startTime = Date.now();

            const owner = process.env.GITHUB_REPOSITORY_OWNER;
            const repo = process.env.GITHUB_REPOSITORY.split('/')[1];

            console.log(`ğŸ” Checking deployment status for commit: ${commitSha}`);
            console.log(`Repo: ${owner}/${repo}`);

            while (Date.now() - startTime < maxWaitTime) {
              try {
                // 1) Deployments APIï¼ˆæœ‰äº›é›†æˆä¼šç”¨ deploymentï¼‰
                const { data: deployments } = await github.rest.repos.listDeployments({
                  owner,
                  repo,
                  sha: commitSha,
                  per_page: 1,
                });

                if (deployments.length > 0) {
                  const deployment = deployments[0];
                  console.log(`ğŸ“¦ Found deployment: ${deployment.id}`);

                  const { data: statuses } = await github.rest.repos.listDeploymentStatuses({
                    owner,
                    repo,
                    deployment_id: deployment.id,
                    per_page: 5,
                  });

                  if (statuses.length > 0) {
                    const status = statuses[0];
                    console.log(`ğŸ“Š Deployment status: ${status.state}`);

                    if (status.state === 'success') {
                      console.log('âœ… Deployment succeeded!');
                      core.setOutput('status', 'success');
                      return;
                    }
                    if (status.state === 'failure' || status.state === 'error') {
                      console.log(`âŒ Deployment failed: ${status.state}`);
                      core.setOutput('status', 'failure');
                      return;
                    }
                  } else {
                    console.log('â„¹ï¸ Deployment exists but no status yet');
                  }
                } else {
                  console.log('â„¹ï¸ No deployment object found yet');
                }

                // 2) Combined Statusï¼ˆVercel å¸¸ç”¨ commit status / checkï¼‰
                const { data: combined } = await github.rest.repos.getCombinedStatusForRef({
                  owner,
                  repo,
                  ref: commitSha,
                });

                const statuses = combined.statuses || [];
                const vercelLike = statuses.find(s => {
                  const ctx = (s.context || '').toLowerCase();
                  return ctx.includes('vercel');
                });

                if (vercelLike) {
                  console.log(`ğŸ“Š Vercel-like status context: ${vercelLike.context}`);
                  console.log(`ğŸ“Š Vercel-like status state: ${vercelLike.state}`);

                  if (vercelLike.state === 'success') {
                    console.log('âœ… Vercel deployment succeeded!');
                    core.setOutput('status', 'success');
                    return;
                  }
                  if (vercelLike.state === 'failure' || vercelLike.state === 'error') {
                    console.log(`âŒ Vercel deployment failed: ${vercelLike.state}`);
                    core.setOutput('status', 'failure');
                    return;
                  }
                } else {
                  console.log('â„¹ï¸ No vercel-like commit status found yet');
                }

                console.log('â³ Deployment in progress, waiting...');
                await new Promise(r => setTimeout(r, checkInterval));
              } catch (error) {
                console.log(`âš ï¸ Error checking deployment: ${error.message}`);
                await new Promise(r => setTimeout(r, checkInterval));
              }
            }

            console.log('â° Timeout reached, assuming deployment will succeed');
            core.setOutput('status', 'timeout');

  sync-to-upstream:
    name: Create PR to Upstream
    needs: check-deployment
    runs-on: ubuntu-latest

    # åªåœ¨ä½ æœ¬äººè§¦å‘ + éƒ¨ç½²æˆåŠŸæˆ–è¶…æ—¶æ‰ç»§ç»­
    if: >
      github.repository_owner == 'demongodYY' &&
      github.actor == 'demongodYY' &&
      (needs.check-deployment.outputs.deployment-status == 'success' ||
       needs.check-deployment.outputs.deployment-status == 'timeout')

    steps:
      - name: Debug gate result
        run: |
          echo "âœ… Passed deployment gate"
          echo "deployment-status: ${{ needs.check-deployment.outputs.deployment-status }}"

      - name: Debug PAT presence (masked)
        env:
          PAT_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "ğŸ” PAT debug (masked)"
          if [ -z "$PAT_TOKEN" ]; then
            echo "âŒ PAT secret is empty/unavailable in this run context"
            exit 1
          fi
          echo "âœ… PAT is available"
          echo "PAT length: ${#PAT_TOKEN}"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote + fetch
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}.git || true
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}

      - name: Check for changes
        id: diff
        run: |
          if git diff --quiet HEAD upstream/${{ env.UPSTREAM_BRANCH }}; then
            echo "no-changes=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected"
          else
            echo "no-changes=false" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected:"
            git diff --stat HEAD upstream/${{ env.UPSTREAM_BRANCH }}
          fi

      - name: Debug PAT access to upstream repo
        if: steps.diff.outputs.no-changes == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            console.log('ğŸ” PAT is provided to github-script (value not printed).');

            const { data } = await github.rest.repos.get({
              owner: process.env.UPSTREAM_OWNER,
              repo: process.env.UPSTREAM_REPO,
            });

            console.log(`âœ… Can access upstream repo: ${data.full_name}`);
            console.log(`   Visibility: ${data.private ? 'private' : 'public'}`);

      - name: Check existing PRs
        if: steps.diff.outputs.no-changes == 'false'
        id: pr-check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const owner = process.env.UPSTREAM_OWNER;
            const repo  = process.env.UPSTREAM_REPO;
            const fork  = process.env.GITHUB_REPOSITORY;

            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              per_page: 100,
            });

            const existing = prs.find(pr =>
              pr.head.repo?.full_name === fork &&
              pr.head.ref === 'main'
            );

            if (existing) {
              console.log(`âš ï¸ Existing PR found: #${existing.number}`);
              core.setOutput('exists', 'true');
              core.setOutput('number', existing.number.toString());
              core.setOutput('url', existing.html_url);
            } else {
              console.log('âœ… No existing sync PR found');
              core.setOutput('exists', 'false');
            }

      - name: Create PR to upstream
        if: steps.diff.outputs.no-changes == 'false' && steps.pr-check.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const owner = process.env.UPSTREAM_OWNER;
            const repo  = process.env.UPSTREAM_REPO;

            const forkOwner = process.env.GITHUB_REPOSITORY_OWNER;
            const forkRepo  = process.env.GITHUB_REPOSITORY; // downstream full name

            const sha = process.env.GITHUB_SHA;
            const runId = process.env.GITHUB_RUN_ID;
            const deploymentStatus = '${{ needs.check-deployment.outputs.deployment-status }}';

            const title = `ğŸ”„ Sync from downstream: ${sha.substring(0,7)}`;

            const body = [
              '## ğŸ”„ è‡ªåŠ¨åŒæ­¥æ›´æ–°',
              '',
              'æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºï¼Œç”¨äºåŒæ­¥ä¸‹æ¸¸ä»“åº“çš„æ›´æ–°ã€‚',
              '',
              `**æ¥æºä»“åº“**: ${forkRepo}`,
              `**æäº¤**: \`${sha}\``,
              `**éƒ¨ç½²çŠ¶æ€**: ${deploymentStatus}`,
              '',
              `*Run: ${process.env.GITHUB_SERVER_URL}/${forkRepo}/actions/runs/${runId}*`,
            ].join('\n');

            console.log(`Creating PR: ${forkOwner}:main -> ${owner}/${repo}:main`);

            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title,
              body,
              head: `${forkOwner}:main`,
              base: 'main',
            });

            console.log(`âœ… PR created: #${pr.number}`);
            console.log(`ğŸ”— ${pr.html_url}`);

      - name: Summary
        if: steps.diff.outputs.no-changes == 'false'
        run: |
          echo "ğŸ“Š Summary"
          echo "deployment-status: ${{ needs.check-deployment.outputs.deployment-status }}"
          echo "existing-pr: ${{ steps.pr-check.outputs.exists }}"
          echo "existing-pr-number/url: ${{ steps.pr-check.outputs.number }} ${{ steps.pr-check.outputs.url }}"

      - name: No changes
        if: steps.diff.outputs.no-changes == 'true'
        run: echo "â„¹ï¸ Nothing to sync"