name: Sync to Upstream Repository

on:
  push:
    branches:
      - main
    # åªå¤„ç†ä»“åº“ owner çš„æäº¤ï¼ˆè§¦å‘ CD çš„æäº¤ï¼‰
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  UPSTREAM_REPO: OpenRareDisease/info_platform
  UPSTREAM_BRANCH: main

jobs:
  check-deployment:
    name: Wait for Vercel Deployment
    runs-on: ubuntu-latest
    if: github.repository_owner == 'demongodYY' # åªåœ¨ä¸‹æ¸¸ä»“åº“è¿è¡Œ
    outputs:
      deployment-status: ${{ steps.check.outputs.status }}
    steps:
      - name: Check Vercel deployment status
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commitSha = '${{ github.sha }}';
            const maxWaitTime = 10 * 60 * 1000; // 10 åˆ†é’Ÿ
            const checkInterval = 30 * 1000; // 30 ç§’æ£€æŸ¥ä¸€æ¬¡
            const startTime = Date.now();
            
            console.log(`ğŸ” Checking deployment status for commit: ${commitSha}`);
            
            while (Date.now() - startTime < maxWaitTime) {
              try {
                // æ£€æŸ¥ GitHub Deployments API
                const { data: deployments } = await github.rest.repos.listDeployments({
                  owner: process.env.GITHUB_REPOSITORY_OWNER,
                  repo: process.env.GITHUB_REPOSITORY.split('/')[1],
                  sha: commitSha,
                  per_page: 1,
                });
                
                if (deployments.length > 0) {
                  const deployment = deployments[0];
                  console.log(`ğŸ“¦ Found deployment: ${deployment.id}`);
                  
                  // æ£€æŸ¥ deployment status
                  const { data: statuses } = await github.rest.repos.listDeploymentStatuses({
                    owner: process.env.GITHUB_REPOSITORY_OWNER,
                    repo: process.env.GITHUB_REPOSITORY.split('/')[1],
                    deployment_id: deployment.id,
                    per_page: 1,
                  });
                  
                  if (statuses.length > 0) {
                    const status = statuses[0];
                    console.log(`ğŸ“Š Deployment status: ${status.state}`);
                    
                    if (status.state === 'success') {
                      console.log('âœ… Deployment succeeded!');
                      core.setOutput('status', 'success');
                      return;
                    } else if (status.state === 'failure' || status.state === 'error') {
                      console.log(`âŒ Deployment failed: ${status.state}`);
                      core.setOutput('status', 'failure');
                      return;
                    }
                  }
                }
                
                // ä¹Ÿæ£€æŸ¥ commit statusï¼ˆVercel å¯èƒ½ä¼šè®¾ç½®ï¼‰
                const { data: statuses } = await github.rest.repos.getCombinedStatusForRef({
                  owner: process.env.GITHUB_REPOSITORY_OWNER,
                  repo: process.env.GITHUB_REPOSITORY.split('/')[1],
                  ref: commitSha,
                });
                
                const vercelStatus = statuses.statuses.find(s => 
                  s.context.includes('vercel') || s.context.includes('Vercel')
                );
                
                if (vercelStatus) {
                  console.log(`ğŸ“Š Vercel status: ${vercelStatus.state}`);
                  if (vercelStatus.state === 'success') {
                    console.log('âœ… Vercel deployment succeeded!');
                    core.setOutput('status', 'success');
                    return;
                  } else if (vercelStatus.state === 'failure' || vercelStatus.state === 'error') {
                    console.log(`âŒ Vercel deployment failed: ${vercelStatus.state}`);
                    core.setOutput('status', 'failure');
                    return;
                  }
                }
                
                console.log('â³ Deployment in progress, waiting...');
                await new Promise(resolve => setTimeout(resolve, checkInterval));
              } catch (error) {
                console.log(`âš ï¸ Error checking deployment: ${error.message}`);
                // ç»§ç»­ç­‰å¾…
                await new Promise(resolve => setTimeout(resolve, checkInterval));
              }
            }
            
            // è¶…æ—¶åï¼Œå¦‚æœè¿˜æ²¡æ‰¾åˆ°éƒ¨ç½²çŠ¶æ€ï¼Œå‡è®¾æˆåŠŸï¼ˆå¯èƒ½æ˜¯ Vercel è¿˜æ²¡åˆ›å»º statusï¼‰
            console.log('â° Timeout reached, assuming deployment will succeed');
            core.setOutput('status', 'timeout');

  sync-to-upstream:
    name: Create PR to Upstream
    needs: check-deployment
    runs-on: ubuntu-latest
    if: github.repository_owner == 'demongodYY' && (needs.check-deployment.outputs.deployment-status == 'success' || needs.check-deployment.outputs.deployment-status == 'timeout')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git || true
          git remote set-url upstream https://github.com/${{ env.UPSTREAM_REPO }}.git

      - name: Fetch upstream
        run: |
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}

      - name: Check for changes
        id: check-changes
        run: |
          # æ£€æŸ¥å½“å‰åˆ†æ”¯å’Œä¸Šæ¸¸åˆ†æ”¯æ˜¯å¦æœ‰å·®å¼‚
          if git diff --quiet HEAD upstream/${{ env.UPSTREAM_BRANCH }}; then
            echo "no-changes=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes to sync"
          else
            echo "no-changes=false" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected, will create PR"
            # æ˜¾ç¤ºå˜æ›´ç»Ÿè®¡
            echo "ğŸ“Š Change summary:"
            git diff --stat HEAD upstream/${{ env.UPSTREAM_BRANCH }}
          fi

      - name: Check for existing PRs
        if: steps.check-changes.outputs.no-changes == 'false'
        id: check-prs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: 'OpenRareDisease',
              repo: 'info_platform',
              state: 'open',
            });
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœªåˆå¹¶çš„åŒæ­¥ PRï¼ˆä»å½“å‰ fork åˆ›å»ºçš„ï¼‰
            const [forkOwner] = process.env.GITHUB_REPOSITORY.split('/');
            const syncPRs = prs.filter(pr => 
              pr.head.repo.full_name === process.env.GITHUB_REPOSITORY &&
              pr.head.ref === 'main'
            );
            
            if (syncPRs.length > 0) {
              console.log(`âš ï¸ Found ${syncPRs.length} existing sync PR(s):`);
              syncPRs.forEach(pr => {
                console.log(`  - #${pr.number}: ${pr.title} (${pr.head.ref})`);
              });
              core.setOutput('has-open-pr', 'true');
              core.setOutput('pr-number', syncPRs[0].number.toString());
            } else {
              console.log('âœ… No existing sync PR found');
              core.setOutput('has-open-pr', 'false');
            }

      - name: Create Pull Request using GitHub API
        if: steps.check-changes.outputs.no-changes == 'false' && steps.check-prs.outputs.has-open-pr == 'false'
        id: create-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commitMessage = '${{ github.event.head_commit.message }}'.replace(/'/g, "\\'");
            const commitAuthor = '${{ github.event.head_commit.author.name }}';
            const commitTime = '${{ github.event.head_commit.timestamp }}';
            const commitSha = '${{ github.sha }}';
            const repo = '${{ github.repository }}';
            const beforeSha = '${{ github.event.before }}';
            
            // è·å–éƒ¨ç½²çŠ¶æ€
            const deploymentStatus = '${{ needs.check-deployment.outputs.deployment-status }}';
            const deploymentStatusEmoji = deploymentStatus === 'success' ? 'âœ…' : 'â°';
            const deploymentStatusText = deploymentStatus === 'success' 
              ? 'Vercel éƒ¨ç½²å·²æˆåŠŸå®Œæˆ' 
              : 'Vercel éƒ¨ç½²çŠ¶æ€æ£€æŸ¥è¶…æ—¶ï¼ˆå¯èƒ½ä»åœ¨è¿›è¡Œä¸­ï¼‰';
            
            // åˆ›å»º PR çš„ body
            const prBody = `## ğŸ”„ è‡ªåŠ¨åŒæ­¥æ›´æ–°
            
            æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºï¼Œç”¨äºåŒæ­¥ä¸‹æ¸¸ä»“åº“çš„æ›´æ–°ã€‚
            
            **æ¥æºä»“åº“**: [${repo}](https://github.com/${repo})
            **æäº¤**: [\`${commitSha.substring(0, 7)}\`](https://github.com/${repo}/commit/${commitSha})
            **æäº¤ä¿¡æ¯**: ${commitMessage}
            **ä½œè€…**: ${commitAuthor}
            **æäº¤æ—¶é—´**: ${commitTime}
            
            **éƒ¨ç½²çŠ¶æ€**: ${deploymentStatusEmoji} ${deploymentStatusText}
            
            ---
            
            ### ğŸ“‹ å˜æ›´å†…å®¹
            
            æœ¬æ¬¡åŒæ­¥åŒ…å«ä»¥ä¸‹å˜æ›´ï¼š
            - æäº¤ SHA: \`${commitSha}\`
            - å˜æ›´æ–‡ä»¶: æŸ¥çœ‹ [æ–‡ä»¶å˜æ›´](https://github.com/${repo}/compare/${beforeSha}...${commitSha})
            
            ### âœ… æ£€æŸ¥æ¸…å•
            
            - [x] Vercel éƒ¨ç½²çŠ¶æ€å·²æ£€æŸ¥
            - [ ] ä»£ç å·²é€šè¿‡æµ‹è¯•
            - [ ] å·²æ£€æŸ¥å˜æ›´å†…å®¹
            - [ ] ç¡®è®¤æ— å†²çª
            
            > âš ï¸ **æ³¨æ„**: æ­¤ PR ç”±è‡ªåŠ¨åŒ–æµç¨‹åˆ›å»ºï¼Œè¯·ä»”ç»†å®¡æŸ¥åå†åˆå¹¶ã€‚
            
            ---
            
            *æ­¤ PR ç”± [GitHub Actions](${process.env.GITHUB_SERVER_URL}/${repo}/actions/runs/${process.env.GITHUB_RUN_ID}) è‡ªåŠ¨åˆ›å»º*`;
            
            try {
              // ä½¿ç”¨ GitHub API åˆ›å»º PR
              // head æ ¼å¼: owner:branchï¼ŒæŒ‡å‘ fork ä»“åº“çš„ main åˆ†æ”¯
              const [forkOwner] = process.env.GITHUB_REPOSITORY.split('/');
              console.log(`Creating PR from fork: ${forkOwner}:main`);
              
              const { data: pr } = await github.rest.pulls.create({
                owner: 'OpenRareDisease',
                repo: 'info_platform',
                title: `ğŸ”„ Sync from downstream: ${commitMessage}`,
                body: prBody,
                head: `${forkOwner}:main`, // fork ä»“åº“çš„ main åˆ†æ”¯
                base: 'main',
              });
              
              console.log(`âœ… Successfully created PR #${pr.number}`);
              console.log(`ğŸ”— PR URL: ${pr.html_url}`);
              
              // æ·»åŠ æ ‡ç­¾
              await github.rest.issues.addLabels({
                owner: 'OpenRareDisease',
                repo: 'info_platform',
                issue_number: pr.number,
                labels: ['automated', 'sync'],
              });
              
              core.setOutput('pr-number', pr.number.toString());
              core.setOutput('pr-url', pr.html_url);
            } catch (error) {
              console.error('âŒ Failed to create PR:', error.message);
              if (error.status === 422) {
                console.log('âš ï¸ PR might already exist or there are no changes');
              }
              throw error;
            }

      - name: Comment on existing PR
        if: steps.check-changes.outputs.no-changes == 'false' && steps.check-prs.outputs.has-open-pr == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.check-prs.outputs.pr-number }}');
            const commitMessage = '${{ github.event.head_commit.message }}'.replace(/'/g, "\\'");
            const commitSha = '${{ github.sha }}';
            const repo = '${{ github.repository }}';
            const beforeSha = '${{ github.event.before }}';
            
            const comment = `ğŸ”„ **è‡ªåŠ¨æ›´æ–°é€šçŸ¥**
            
            æ£€æµ‹åˆ°æ–°çš„æäº¤ï¼Œä½†å·²å­˜åœ¨æœªåˆå¹¶çš„åŒæ­¥ PR #${prNumber}ã€‚
            
            è¯·å…ˆåˆå¹¶æˆ–å…³é—­ç°æœ‰ PRï¼Œç„¶åå†åˆ›å»ºæ–°çš„åŒæ­¥ PRã€‚
            
            **æ–°æäº¤ä¿¡æ¯**:
            - SHA: \`${commitSha.substring(0, 7)}\`
            - æ¶ˆæ¯: ${commitMessage}
            - ä½œè€…: ${{ github.event.head_commit.author.name }}
            
            [æŸ¥çœ‹å˜æ›´](https://github.com/${repo}/compare/${beforeSha}...${commitSha})`;
            
            await github.rest.issues.createComment({
              owner: 'OpenRareDisease',
              repo: 'info_platform',
              issue_number: prNumber,
              body: comment
            });
            
            console.log(`âœ… Commented on existing PR #${prNumber}`);

      - name: Summary
        if: steps.check-changes.outputs.no-changes == 'false'
        run: |
          if [ "${{ steps.check-prs.outputs.has-open-pr }}" == "true" ]; then
            echo "âš ï¸ Existing PR found, commented on it instead of creating new one"
            echo "PR Number: ${{ steps.check-prs.outputs.pr-number }}"
          else
            echo "âœ… Successfully created PR to upstream repository"
            echo "PR Number: ${{ steps.create-pr.outputs.pr-number }}"
            echo "PR URL: ${{ steps.create-pr.outputs.pr-url }}"
          fi

      - name: No changes message
        if: steps.check-changes.outputs.no-changes == 'true'
        run: |
          echo "â„¹ï¸ No changes detected, skipping PR creation"
